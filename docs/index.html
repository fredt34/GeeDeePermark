<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeeDeePerMark — The Privacy Watermark (Docs)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="site-header">
    <div class="wrap ai-style-change-1">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h1 style="display:inline-block; margin:0;">GeeDeePerMark</h1>
        <!-- GitHub button added near the top -->
        <a class="github-button" href="https://github.com/fredt34/GeeDeePermark" target="_blank" rel="noopener noreferrer" aria-label="View GeeDeePermark on GitHub" style="right:0;display:inline-block;vertical-align:middle;margin-left:1rem;text-decoration:none;color:inherit;/* text-align: right; */">
          <!-- Octocat SVG icon -->
          <svg height="20" width="20" viewBox="0 0 16 16" version="1.1" aria-hidden="true" style="vertical-align:middle; fill:currentColor;">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
                    0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
                    -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89
                    -3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82a7.62 7.62 0 012 0c1.53-1.04
                    2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54
                    1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          <span style="margin-left:0.4rem; vertical-align:middle; font-size:0.95rem;">View on GitHub</span>
        </a>
      </div>
      <p class="tagline">The privacy watermark — control sensitive information.</p>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>What this project does</h2>
      <p>GeeDeePerMark is a tiny FastAPI-based service that applies a visible <strong>text watermark to images and PDFs entirely in memory</strong>. It is designed to be compact and easy to host so organisations can install and run a document-protecting <strong>API</strong> without hassle.

      <ul>
        <li>Accepts: images (JPEG, PNG, etc.) and PDF files.</li>
        <li>Default watermark text: <code>Confidential</code>.</li>
        <li>Text size: allowed values 1, 2, 3, 4 (default 3).</li>
        <li><strong>Processing in-memory only — no file is persisted to disk by the app.</strong></li>
      </ul>
      <p>Share it with your colleagues!</p>
    </section>

    <section class="card">
      <h2>API reference (app.py)</h2>
      <h3>POST /watermark</h3>
      <p>Multipart form upload. The service reads the uploaded file into memory, converts PDFs to a raster (first page only), draws a tiled rotated watermark and returns a watermarked file.</p>

      <h4>Input</h4>
      <ul>
        <li><strong>file</strong> (required) — Upload file. Accepts <code>image/*</code> (PNG, JPEG...) or application/pdf.</li>
        <li><strong>text</strong> (optional) — Watermark text. Default: <code>Confidential</code>.</li>
        <li><strong>text_size</strong> (optional) — Integer 1..4 (default 3). Controls the font pixel size mapping used by the app.</li>
      </ul>

      <h4>Responses</h4>
      <ul>
        <li>200 (image): returns a PNG stream with <code>Content-Type: image/png</code>. The app always writes images out as PNG after watermarking.</li>
        <li>200 (pdf input): returns a single-page PDF with the rasterized, watermarked page and <code>Content-Type: application/pdf</code>. Only the first PDF page is rasterised and returned as a single PDF.</li>
        <li>400 Bad Request: several error paths use HTTPException(400, "...") with messages the app raises, e.g. <code>"Unsupported file. Provide an image or a PDF."</code> or <code>"Empty PDF"</code></li>
        <li>500 Internal Server Error: if watermark drawing fails the app raises <code>HTTPException(500, f"Watermark error: {e}")</code>.</li>
      </ul>

      <h4>Implementation notes: single-file FastAPI app (app.py)</h4>
      <ul>
        <li>The app uses Pillow (PIL) to draw a tiled, rotated watermark onto an RGBA image, then compositing and returning RGB/PNG.</li>
        <li>Font loading: attempts common system fonts (DejaVuSans, Arial); falls back to Pillow default font if none found.</li>
        <li>PDF handling: uses PyMuPDF (fitz) to render the first page at 144 DPI into an RGB image, then watermarking is applied.</li>
        <li>Trademark: a faint "Created with GeeDeePermark - https://geedeepermark.cpvo.org/" text is drawn at the bottom-right of the output.</li>
        <li>All processing is done in-memory via BytesIO; the app does not write files to disk.</li>
        <li>IP adresses are NOT logged, only stats.</li>
      </ul>
    </section>

    <section class="card">
      <h2>Examples</h2>

      <h4>Watermark an image and save the result as PNG</h4>
      <pre class="example">
curl -X POST "https://geedeepermark.cpvo.org/" \
  -F "file=@/path/to/id.jpg" \
  -F "text=Confidential" \
  -F "text_size=3" \
  --output protected-id.png
      </pre>

      <h4>Watermark a PDF (first page only) and save the re-embedded single-page PDF</h4>
      <pre class="example">
curl -X POST "https://geedeepermark.cpvo.org/" \
  -F "file=@/path/to/document.pdf" \
  -F "text=For Audit Only" \
  --output protected.pdf
      </pre>

      <h4>Example error responses (literal strings used by app)</h4>
      <pre class="example">
HTTP/1.1 400 Bad Request
Content-Type: application/json

{ "detail": "Unsupported file. Provide an image or a PDF." }

-- or --

HTTP/1.1 400 Bad Request
{ "detail": "Empty PDF" }

-- or --

HTTP/1.1 500 Internal Server Error
{ "detail": "Watermark error: <exception message>" }
      </pre>
    </section>

    <section class="card">
      <h2>Operational notes & limits</h2>
      <ul>
        <li>PDF pages: only the first page is processed. If you need multi-page PDF support, we can extend the code to loop pages and reassemble PDF.</li>
        <li>Image formats: the app uses Pillow's autodetection; some exotic formats may fail.</li>
        <li>Run as unprivileged user: the provided systemd service runs as <code>caddy</code> and the venv is chowned to that user in setup scripts.</li>
      </ul>
    </section>

    <section class="card">
      <h2>Security & privacy</h2>
      <ul>
        <li>Processing is ephemeral and in-memory — the repo explicitly states "no image is ever stored".</li>
        <li>Use TLS (reverse proxy) and restrict access to the service. Do not expose the raw uvicorn port publicly.</li>
        <li>Do not log file contents. The code currently does not persist images; ensure any added logging remains metadata-only.</li>
        <li>Don't trust me. Run the API on your servers.</li>
      </ul>
    </section>

    <section class="card">
      <h2>Dependencies</h2>
      <pre class="example">
(venv)
fastapi
uvicorn
pillow
pymupdf
python-multipart</pre>
      <p><code>venv</code> is highly recommended. Install example (as deploy user): <code>./venv/bin/pip install fastapi uvicorn pillow pymupdf python-multipart</code></p>
    </section>

    <section class="card">
      <h2>Files of interest in this repo</h2>
      <ul>
        <li><code>app.py</code> — single-file FastAPI application.</li>
        <li><code>setup/geedeepermark.service</code> — example systemd unit used in production.</li>
        <li><code>setup/SETUP</code> — local install & deployment notes (Caddy config snippet included).</li>
        <li><code>README.md</code> — project README (concise project goals).</li>
      </ul>
    </section>

    <section class="card">
      <h2>Contributing & next steps</h2>
      <ul>
        <li>Update <code>app.py</code> to match desired features and add tests.</li>
        <li>Adjust docs and include exact example responses and error codes.</li>
        <li>Optionally add a requirements.txt and an example Caddyfile for deployment.</li>
      </ul>
    </section>

  </main>

  <footer class="site-footer">
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
      <p style="margin:0;">GeeDeePerMark — Privacy watermark service, brought to you by FredT34, a seasonned DPO.</p>

      <!-- Footer GitHub link -->
      <a href="https://github.com/fredt34/GeeDeePermark"
         target="_blank"
         rel="noopener noreferrer"
         aria-label="GeeDeePermark repository on GitHub"
         style="display:inline-flex; align-items:center; gap:0.5rem; text-decoration:none; color:inherit; font-size:0.95rem;">
        <svg height="18" width="18" viewBox="0 0 16 16" version="1.1" aria-hidden="true" style="fill:currentColor;">
          <path fill-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
                   0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
                   -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89
                   -3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82a7.62 7.62 0 012 0c1.53-1.04
                   2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54
                   1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
        <span>Repository on GitHub</span>
      </a>
    </div>
  </footer>
</body>
</html>
